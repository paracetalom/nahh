<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SmartBin Scanner</title>

<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

<style>
body{margin:0;font-family:'Kanit',sans-serif;background:#f5f5f5;display:flex;flex-direction:column;height:100vh;overflow:hidden;}
#camera-wrapper{position:relative;flex:1;background:#000;display:flex;justify-content:center;align-items:center;}
canvas{width:100%;height:100%;object-fit:cover;}
.control-btn{position:absolute;top:20px;background:rgba(0,0,0,0.4);color:white;border:none;border-radius:50%;width:45px;height:45px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
#btn-power{left:20px;}
#btn-switch{right:20px;}
#status-msg{color:#aaa;position:absolute;}
#result-panel{background:white;padding:20px 25px;border-radius:20px 20px 0 0;min-height:180px;}
.result-row{display:flex;align-items:center;margin-bottom:15px;}
.label-name{width:60px;font-weight:500;}
.progress-track{flex:1;height:25px;background:#eee;border-radius:6px;overflow:hidden;position:relative;}
.progress-fill{height:100%;width:0%;background:#4CAF50;transition:0.2s;}
.percent-text{position:absolute;right:10px;top:50%;transform:translateY(-50%);font-size:12px;}
</style>
</head>

<body>

<div id="camera-wrapper">
<p id="status-msg">ปิดกล้องอยู่</p>

<button id="btn-power" class="control-btn" onclick="toggleCamera()">
<span class="material-icons" id="icon-power">videocam_off</span>
</button>

<button id="btn-switch" class="control-btn" onclick="switchCamera()">
<span class="material-icons">flip_camera_ios</span>
</button>

<div id="webcam-container"></div>
</div>

<div id="result-panel">
<div class="result-row">
<div class="label-name">PET</div>
<div class="progress-track">
<span class="percent-text" id="text-PET">0%</span>
<div class="progress-fill" id="bar-PET"></div>
</div>
</div>

<div class="result-row">
<div class="label-name">HDPE</div>
<div class="progress-track">
<span class="percent-text" id="text-HDPE">0%</span>
<div class="progress-fill" id="bar-HDPE"></div>
</div>
</div>
</div>

<script>
const URL="https://teachablemachine.withgoogle.com/models/EV-mbCqpx/";

let model,webcam,maxPredictions;
let isCameraOn=false;
let currentFacingMode="environment"; // เริ่มกล้องหลัง
let loopId=null;

async function loadModel(){
    model=await tmImage.load(URL+"model.json",URL+"metadata.json");
    maxPredictions=model.getTotalClasses();
    document.getElementById("status-msg").innerText="พร้อมใช้งาน";
}
loadModel();

async function toggleCamera(){
    const icon=document.getElementById("icon-power");
    const status=document.getElementById("status-msg");

    if(isCameraOn){
        await stopLoop();
        if(webcam) await webcam.stop();
        webcam=null;
        document.getElementById("webcam-container").innerHTML="";
        isCameraOn=false;
        icon.innerText="videocam_off";
        status.innerText="กล้องถูกปิด";
        status.style.display="block";
        resetBars();
    }else{
        await initWebcam();
        isCameraOn=true;
        icon.innerText="videocam";
        status.style.display="none";
    }
}

async function switchCamera(){
    if(!isCameraOn) return;
    currentFacingMode=currentFacingMode==="environment"?"user":"environment";
    await stopLoop();
    if(webcam) await webcam.stop();
    webcam=null;
    document.getElementById("webcam-container").innerHTML="";
    await initWebcam();
}

async function initWebcam(){
    try{
        webcam=new tmImage.Webcam(400,400,false);
        await webcam.setup({facingMode:{exact:currentFacingMode}});
        await webcam.play();

        const canvas=webcam.canvas;

        // ⭐ แก้ mirror กล้องหน้า
        if(currentFacingMode==="user"){
            canvas.style.transform="scaleX(-1)";
        }else{
            canvas.style.transform="scaleX(1)";
        }

        document.getElementById("webcam-container").appendChild(canvas);
        loopId=requestAnimationFrame(loop);
    }catch(err){
        console.error(err);
        document.getElementById("status-msg").innerText="เปิดกล้องไม่ได้";
    }
}

async function loop(){
    if(webcam&&isCameraOn){
        webcam.update();
        await predict();
        loopId=requestAnimationFrame(loop);
    }
}

async function predict(){
    const prediction=await model.predict(webcam.canvas);
    for(let i=0;i<prediction.length;i++){
        const name=prediction[i].className;
        const percent=Math.round(prediction[i].probability*100);
        updateBar(name,percent);
    }
}

function updateBar(label,percent){
    const bar=document.getElementById("bar-"+label);
    const text=document.getElementById("text-"+label);
    if(bar){
        bar.style.width=percent+"%";
        text.innerText=percent+"%";
    }
}

function resetBars(){
    document.querySelectorAll(".progress-fill").forEach(e=>e.style.width="0%");
    document.querySelectorAll(".percent-text").forEach(e=>e.innerText="0%");
}

async function stopLoop(){
    if(loopId) cancelAnimationFrame(loopId);
}
</script>

</body>
</html>
